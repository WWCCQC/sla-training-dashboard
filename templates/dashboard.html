{% extends "layout.html" %}

{% block title %}Dashboard - SLA Training{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">SLA Training Dashboard</h1>
    <p class="text-gray-600">ภาพรวมการติดตาม SLA การลงทะเบียนช่าง</p>
</div>

<!-- KPI Cards Row 1 -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Total Technicians -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">ช่างทั้งหมด</p>
                <h3 class="text-3xl font-bold text-gray-800">{{ summary.total }}</h3>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-users text-blue-500 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Closed -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">ปิดงาน/ไม่ผ่าน</p>
                <h3 class="text-3xl font-bold text-red-600">{{ summary.closed }}</h3>
                <p class="text-xs text-red-600 mt-1">{{ summary.closed_rate }}%</p>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-times-circle text-red-500 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- On Process -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">อยู่ระหว่างดำเนินการ</p>
                <h3 class="text-3xl font-bold text-yellow-600">{{ summary.onprocess }}</h3>
                <p class="text-xs text-yellow-600 mt-1">{{ summary.onprocess_rate }}%</p>
            </div>
            <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                <i class="fas fa-spinner text-yellow-500 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Completed -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">ขึ้นทะเบียนเรียบร้อย</p>
                <h3 class="text-3xl font-bold text-green-600">{{ summary.completed }}</h3>
                <p class="text-xs text-green-600 mt-1">{{ summary.completed_rate }}%</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-check-circle text-green-500 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- KPI Cards Row 2 - Training Results -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <!-- Theory Training -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-gray-700 font-medium">ผลอบรมทฤษฎี</h4>
            <span class="text-2xl font-bold text-blue-600">{{ summary.theory_rate }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-blue-600 h-3 rounded-full" style="width: {{ summary.theory_rate }}%"></div>
        </div>
        <div class="flex justify-between text-sm mt-2">
            <span class="text-blue-600"><i class="fas fa-users"></i> เข้าอบรม {{ summary.theory_pass + summary.theory_fail }}</span>
        </div>
        <div class="flex justify-between text-sm mt-1">
            <span class="text-green-600"><i class="fas fa-check"></i> ผ่าน {{ summary.theory_pass }}</span>
            <span class="text-red-600"><i class="fas fa-times"></i> ไม่ผ่าน {{ summary.theory_fail }}</span>
        </div>
    </div>
    
    <!-- OJT -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-gray-700 font-medium">ผล OJT</h4>
            <span class="text-2xl font-bold text-purple-600">{{ summary.ojt_rate }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-purple-600 h-3 rounded-full" style="width: {{ summary.ojt_rate }}%"></div>
        </div>
        <div class="flex justify-between text-sm mt-2">
            <span class="text-purple-600"><i class="fas fa-users"></i> เข้า OJT {{ summary.ojt_pass + summary.ojt_fail }}</span>
        </div>
        <div class="flex justify-between text-sm mt-1">
            <span class="text-green-600"><i class="fas fa-check"></i> ผ่าน {{ summary.ojt_pass }}</span>
            <span class="text-red-600"><i class="fas fa-times"></i> ไม่ผ่าน {{ summary.ojt_fail }}</span>
        </div>
    </div>
    
    <!-- Average SLA -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-gray-700 font-medium">SLA เฉลี่ยรวม</h4>
            <span class="text-2xl font-bold {% if summary.avg_sla_total <= 45 %}text-green-600{% elif summary.avg_sla_total <= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                {{ summary.avg_sla_total }} วัน
            </span>
        </div>
        <div class="text-sm text-gray-500">
            <i class="fas fa-info-circle"></i> ระยะเวลาเฉลี่ยจากเริ่มต้นจนขึ้นทะเบียนสำเร็จ
        </div>
    </div>
</div>

<!-- SLA by Step Section -->
<div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-list-ol text-blue-500 mr-2"></i>SLA แต่ละขั้นตอน (6 ขั้นตอน)
    </h3>
    <div class="overflow-x-auto">
        <div class="flex gap-3 pb-2">
            {% for step in sla_steps %}
            <div class="flex-shrink-0 w-40 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border">
                <div class="text-center">
                    <div class="text-xs text-gray-500 mb-1">{{ loop.index }}. {{ step.name }}</div>
                    <div class="text-2xl font-bold {% if step.avg_sla <= 7 %}text-green-600{% elif step.avg_sla <= 14 %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {{ step.avg_sla }}
                    </div>
                    <div class="text-xs text-gray-400">วันเฉลี่ย</div>
                    <div class="text-xs text-green-600 mt-2">
                        <i class="fas fa-check"></i> {{ step.complete }} Complete
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Monthly Trend Chart -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-line text-blue-500 mr-2"></i>จำนวนช่างรายเดือน
        </h3>
        <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>
    
    <!-- Status Pie Chart -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-pie text-green-500 mr-2"></i>สถานะการลงทะเบียน
        </h3>
        <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<!-- Area Step Summary Table -->
<div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-table text-indigo-500 mr-2"></i>ตารางสรุป: จำนวนช่างและระยะเวลารอ (SLA) แยกตามพื้นที่
    </h3>
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="areaStepSummaryTable">
            <thead class="bg-gray-800 text-white">
                <tr>
                    <th class="px-3 py-3 text-left font-medium" rowspan="2">พื้นที่ (Area)</th>
                    <th class="px-3 py-3 text-center font-medium" rowspan="2">ลงทะเบียน<br>(คน)</th>
                    <th class="px-3 py-3 text-center font-medium bg-green-700" rowspan="2">เสร็จสิ้น<br>(คน)</th>
                    <th class="px-3 py-3 text-center font-medium" rowspan="2">Closed<br>(คน)</th>
                    <th class="px-3 py-3 text-center font-medium bg-yellow-600" rowspan="2">อยู่ระหว่าง<br>ดำเนินการ</th>
                    <th class="px-3 py-3 text-center font-medium bg-blue-700" colspan="2">อบรม</th>
                    <th class="px-3 py-3 text-center font-medium bg-purple-700" colspan="2">OJT</th>
                    <th class="px-3 py-3 text-center font-medium bg-indigo-700" colspan="2">ทำบัตร</th>
                    <th class="px-3 py-3 text-center font-medium bg-cyan-700" colspan="2">ตรวจความพร้อม</th>
                    <th class="px-3 py-3 text-center font-medium bg-teal-700" colspan="2">DFlow</th>
                    <th class="px-3 py-3 text-center font-medium bg-orange-700" colspan="2">ขึ้นทะเบียน</th>
                </tr>
                <tr class="bg-gray-700 text-white">
                    <th class="px-2 py-2 text-center font-medium text-xs bg-blue-600">คน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-blue-600">วัน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-purple-600">คน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-purple-600">วัน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-indigo-600">คน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-indigo-600">วัน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-cyan-600">คน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-cyan-600">วัน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-teal-600">คน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-teal-600">วัน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-orange-600">คน</th>
                    <th class="px-2 py-2 text-center font-medium text-xs bg-orange-600">วัน</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for item in area_step_summary %}
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-3 font-medium text-gray-800">{{ item.area }}</td>
                    <td class="px-3 py-3 text-center font-medium">{{ item.total }}</td>
                    <td class="px-3 py-3 text-center text-green-600 font-medium">{{ item.completed }}</td>
                    <td class="px-3 py-3 text-center text-red-600 font-medium">{{ item.closed }}</td>
                    <td class="px-3 py-3 text-center text-yellow-600 font-medium">{{ item.onprocess }}</td>
                    <!-- อบรม -->
                    <td class="px-2 py-3 text-center">{{ item.steps.training.count }}</td>
                    <td class="px-2 py-3 text-center {% if item.steps.training.avg_sla > 14 %}text-red-600 font-medium{% elif item.steps.training.avg_sla > 7 %}text-yellow-600{% else %}text-gray-600{% endif %}">
                        {% if item.steps.training.avg_sla > 0 %}{{ item.steps.training.avg_sla }}{% else %}-{% endif %}
                    </td>
                    <!-- OJT -->
                    <td class="px-2 py-3 text-center">{{ item.steps.ojt.count }}</td>
                    <td class="px-2 py-3 text-center {% if item.steps.ojt.avg_sla > 14 %}text-red-600 font-medium{% elif item.steps.ojt.avg_sla > 7 %}text-yellow-600{% else %}text-gray-600{% endif %}">
                        {% if item.steps.ojt.avg_sla > 0 %}{{ item.steps.ojt.avg_sla }}{% else %}-{% endif %}
                    </td>
                    <!-- GenID -->
                    <td class="px-2 py-3 text-center">{{ item.steps.genid.count }}</td>
                    <td class="px-2 py-3 text-center {% if item.steps.genid.avg_sla > 14 %}text-red-600 font-medium{% elif item.steps.genid.avg_sla > 7 %}text-yellow-600{% else %}text-gray-600{% endif %}">
                        {% if item.steps.genid.avg_sla > 0 %}{{ item.steps.genid.avg_sla }}{% else %}-{% endif %}
                    </td>
                    <!-- ตรวจความพร้อม -->
                    <td class="px-2 py-3 text-center">{{ item.steps.inspection.count }}</td>
                    <td class="px-2 py-3 text-center {% if item.steps.inspection.avg_sla > 14 %}text-red-600 font-medium{% elif item.steps.inspection.avg_sla > 7 %}text-yellow-600{% else %}text-gray-600{% endif %}">
                        {% if item.steps.inspection.avg_sla > 0 %}{{ item.steps.inspection.avg_sla }}{% else %}-{% endif %}
                    </td>
                    <!-- DFlow -->
                    <td class="px-2 py-3 text-center">{{ item.steps.dflow.count }}</td>
                    <td class="px-2 py-3 text-center {% if item.steps.dflow.avg_sla > 14 %}text-red-600 font-medium{% elif item.steps.dflow.avg_sla > 7 %}text-yellow-600{% else %}text-gray-600{% endif %}">
                        {% if item.steps.dflow.avg_sla > 0 %}{{ item.steps.dflow.avg_sla }}{% else %}-{% endif %}
                    </td>
                    <!-- ขึ้นทะเบียน -->
                    <td class="px-2 py-3 text-center">{{ item.steps.registration.count }}</td>
                    <td class="px-2 py-3 text-center {% if item.steps.registration.avg_sla > 14 %}text-red-600 font-medium{% elif item.steps.registration.avg_sla > 7 %}text-yellow-600{% else %}text-gray-600{% endif %}">
                        {% if item.steps.registration.avg_sla > 0 %}{{ item.steps.registration.avg_sla }}{% else %}-{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Area Statistics Table with Hierarchy -->
<div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>สถิติตามพื้นที่ (Area)
        <span class="text-sm font-normal text-gray-500 ml-2">คลิกที่ตัวเลข Onprocess/Closed เพื่อดูรายละเอียด</span>
    </h3>
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="areaTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left font-medium text-gray-600">พื้นที่</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">ทั้งหมด</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">Completed</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">Onprocess</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">Closed</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">SLA เฉลี่ย</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">อัตราสำเร็จ</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for area in areas %}
                <!-- Main Row -->
                <tr class="hover:bg-gray-50 area-main-row" data-area-idx="{{ loop.index0 }}">
                    <td class="px-4 py-3 font-medium text-gray-800">{{ area.area }}</td>
                    <td class="px-4 py-3 text-center">{{ area.total }}</td>
                    <td class="px-4 py-3 text-center text-green-600 font-medium">{{ area.completed }}</td>
                    <td class="px-4 py-3 text-center">
                        {% if area.onprocess > 0 %}
                        <button class="toggle-breakdown text-yellow-600 font-medium hover:bg-yellow-100 px-2 py-1 rounded cursor-pointer" 
                                data-target="onprocess-{{ loop.index0 }}" data-type="onprocess">
                            <i class="fas fa-plus-circle mr-1 toggle-icon"></i>{{ area.onprocess }}
                        </button>
                        {% else %}
                        <span class="text-gray-400">0</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        {% if area.closed > 0 %}
                        <button class="toggle-breakdown text-red-600 font-medium hover:bg-red-100 px-2 py-1 rounded cursor-pointer" 
                                data-target="closed-{{ loop.index0 }}" data-type="closed">
                            <i class="fas fa-plus-circle mr-1 toggle-icon"></i>{{ area.closed }}
                        </button>
                        {% else %}
                        <span class="text-gray-400">0</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="{% if area.avg_sla <= 45 %}text-green-600{% elif area.avg_sla <= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                            {{ area.avg_sla }} วัน
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-medium {% if area.success_rate >= 50 %}bg-green-100 text-green-800{% elif area.success_rate >= 25 %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {{ area.success_rate }}%
                        </span>
                    </td>
                </tr>
                
                <!-- Onprocess Breakdown Row (Hidden by default) -->
                <tr class="breakdown-row bg-yellow-50 hidden" id="onprocess-{{ loop.index0 }}">
                    <td colspan="7" class="px-8 py-3">
                        <div class="text-sm">
                            <span class="font-medium text-yellow-700 mb-2 block">
                                <i class="fas fa-list-ul mr-1"></i>รายละเอียด Onprocess - {{ area.area }}
                            </span>
                            <div class="flex flex-wrap gap-2 mt-2">
                                {% for item in area.onprocess_breakdown %}
                                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">
                                    {{ item.status }} ({{ item.count }})
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                
                <!-- Closed Breakdown Row (Hidden by default) -->
                <tr class="breakdown-row bg-red-50 hidden" id="closed-{{ loop.index0 }}">
                    <td colspan="7" class="px-8 py-3">
                        <div class="text-sm">
                            <span class="font-medium text-red-700 mb-2 block">
                                <i class="fas fa-list-ul mr-1"></i>รายละเอียด Closed - {{ area.area }}
                            </span>
                            <div class="flex flex-wrap gap-2 mt-2">
                                {% for item in area.closed_breakdown %}
                                <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs">
                                    {{ item.status }} ({{ item.count }})
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Top Provinces & Trainers -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Top Provinces -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-city text-teal-500 mr-2"></i>Top 10 จังหวัด
        </h3>
        <div class="space-y-2">
            {% for prov in provinces[:10] %}
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                <span class="text-gray-700">{{ prov.province }}</span>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500">{{ prov.total }} ลงทะเบียน</span>
                    <span class="text-sm font-medium text-green-600">{{ prov.completed }} สำเร็จ</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Top Trainers -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chalkboard-teacher text-cyan-500 mr-2"></i>ผู้อบรม
        </h3>
        <div class="space-y-2">
            {% for trainer in trainers %}
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                <span class="text-gray-700 text-sm">{{ trainer.trainer[:40] }}{% if trainer.trainer|length > 40 %}...{% endif %}</span>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500">{{ trainer.total }} อบรม</span>
                    <span class="text-sm font-medium text-green-600">{{ trainer.passed }} ผ่าน</span>
                    <span class="px-2 py-1 rounded-full text-xs {% if trainer.pass_rate >= 50 %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ trainer.pass_rate }}%
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== Area Table Expand/Collapse =====
    document.querySelectorAll('.toggle-breakdown').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const targetRow = document.getElementById(targetId);
            const icon = this.querySelector('.toggle-icon');
            
            if (targetRow) {
                if (targetRow.classList.contains('hidden')) {
                    // Expand
                    targetRow.classList.remove('hidden');
                    icon.classList.remove('fa-plus-circle');
                    icon.classList.add('fa-minus-circle');
                } else {
                    // Collapse
                    targetRow.classList.add('hidden');
                    icon.classList.remove('fa-minus-circle');
                    icon.classList.add('fa-plus-circle');
                }
            }
        });
    });

    // Store chart instances
    let chartInstances = {};
    
    // Helper to create chart safely
    function createChart(canvasId, config) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        
        // Destroy existing chart on this canvas
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        
        const ctx = canvas.getContext('2d');
        config.options = config.options || {};
        config.options.animation = false;
        config.options.responsive = true;
        config.options.maintainAspectRatio = false;
        
        chartInstances[canvasId] = new Chart(ctx, config);
        return chartInstances[canvasId];
    }

    // Status by Area Stacked Bar Chart
    const areaLabels = [{% for a in areas %}'{{ a.area }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const areaCompleted = [{% for a in areas %}{{ a.completed }}{% if not loop.last %},{% endif %}{% endfor %}];
    const areaOnprocess = [{% for a in areas %}{{ a.onprocess }}{% if not loop.last %},{% endif %}{% endfor %}];
    const areaClosed = [{% for a in areas %}{{ a.closed }}{% if not loop.last %},{% endif %}{% endfor %}];
    const areaTotals = [{% for a in areas %}{{ a.total }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    // Custom plugin สำหรับแสดง total บน top ของ stack
    const stackTotalPlugin = {
        id: 'stackTotalPlugin',
        afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            const datasets = chart.data.datasets;
            
            chart.data.labels.forEach((label, i) => {
                let total = 0;
                let maxY = null;
                
                datasets.forEach((dataset, j) => {
                    const meta = chart.getDatasetMeta(j);
                    if (!meta.hidden) {
                        total += dataset.data[i] || 0;
                        const bar = meta.data[i];
                        if (bar && (maxY === null || bar.y < maxY)) {
                            maxY = bar.y;
                        }
                    }
                });
                
                if (total > 0 && maxY !== null) {
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.font = 'bold 12px sans-serif';
                    ctx.fillStyle = '#374151';
                    ctx.fillText(total, chart.getDatasetMeta(0).data[i].x, maxY - 5);
                    ctx.restore();
                }
            });
        }
    };
    
    new Chart(document.getElementById('statusChart'), {
        type: 'bar',
        plugins: [ChartDataLabels, stackTotalPlugin],
        data: {
            labels: areaLabels,
            datasets: [
                {
                    label: 'ขึ้นทะเบียนเรียบร้อย',
                    data: areaCompleted,
                    backgroundColor: '#10B981',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'อยู่ระหว่างดำเนินการ',
                    data: areaOnprocess,
                    backgroundColor: '#F59E0B',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'ปิดงาน/ไม่ผ่าน',
                    data: areaClosed,
                    backgroundColor: '#EF4444',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        afterTitle: function(context) {
                            const idx = context[0].dataIndex;
                            return 'รวม: ' + areaTotals[idx] + ' คน';
                        }
                    }
                }
            }
        }
    });

    // Monthly Trend Chart - ข้อมูลยอดรวมแต่ละเดือน
    const monthlyTotals = [{% for m in monthly %}{{ m.total }}{% if not loop.last %},{% endif %}{% endfor %}];
    const monthlyCompleted = [{% for m in monthly %}{{ m.completed }}{% if not loop.last %},{% endif %}{% endfor %}];
    const monthlyOnprocess = [{% for m in monthly %}{{ m.onprocess }}{% if not loop.last %},{% endif %}{% endfor %}];
    const monthlyClosed = [{% for m in monthly %}{{ m.closed }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    createChart('monthlyChart', {
        type: 'bar',
        data: {
            labels: [{% for m in monthly %}'{{ m.month }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [
                {
                    label: 'ขึ้นทะเบียนเรียบร้อย',
                    data: monthlyCompleted,
                    backgroundColor: '#10B981',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'อยู่ระหว่างดำเนินการ',
                    data: monthlyOnprocess,
                    backgroundColor: '#F59E0B',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'ปิดงาน/ไม่ผ่าน',
                    data: monthlyClosed,
                    backgroundColor: '#EF4444',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                }
            ]
        },
        options: {
            layout: {
                padding: { top: 25 }
            },
            plugins: { 
                legend: { position: 'bottom' },
                datalabels: { display: true }
            },
            scales: { 
                x: { stacked: true }, 
                y: { 
                    stacked: true,
                    afterFit: function(scaleInstance) {
                        scaleInstance.paddingTop = 25;
                    }
                } 
            }
        },
        plugins: [{
            // Custom plugin เพื่อแสดงยอดรวมบนแท่ง
            id: 'totalLabels',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                const datasets = chart.data.datasets;
                const meta = chart.getDatasetMeta(datasets.length - 1);
                
                ctx.save();
                ctx.font = 'bold 13px sans-serif';
                ctx.fillStyle = '#1F2937';
                ctx.textAlign = 'center';
                
                meta.data.forEach((bar, index) => {
                    const total = monthlyTotals[index];
                    if (total > 0) {
                        ctx.fillText(total, bar.x, bar.y - 12);
                    }
                });
                ctx.restore();
            }
        }]
    });
});
</script>
{% endblock %}
