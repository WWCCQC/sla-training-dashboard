{% extends "layout.html" %}

{% block title %}Dashboard - SLA Training{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">SLA Training Dashboard</h1>
    <p class="text-gray-600">ภาพรวมการติดตาม SLA การลงทะเบียนช่าง</p>
</div>

<!-- KPI Cards Row 1 -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <!-- Total Technicians -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">ลงทะเบียนอบรม</p>
                <h3 class="text-3xl font-bold text-gray-800">{{ summary.total }}</h3>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                <i class="fas fa-users text-blue-500 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Closed -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-red-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">ลาออก</p>
                <h3 class="text-3xl font-bold text-red-600">{{ summary.closed }}</h3>
                <p class="text-xs text-red-600 mt-1">{{ summary.closed_rate }}%</p>
            </div>
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <i class="fas fa-times-circle text-red-500 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Cancel -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-gray-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">ยกเลิก</p>
                <h3 class="text-3xl font-bold text-gray-600">{{ summary.cancel }}</h3>
                <p class="text-xs text-gray-600 mt-1">{{ summary.cancel_rate }}%</p>
            </div>
            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                <i class="fas fa-ban text-gray-500 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- On Process -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">อยู่ระหว่างดำเนินการ</p>
                <h3 class="text-3xl font-bold text-yellow-600">{{ summary.onprocess }}</h3>
                <p class="text-xs text-yellow-600 mt-1">{{ summary.onprocess_rate }}%</p>
            </div>
            <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                <i class="fas fa-spinner text-yellow-500 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Completed -->
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">ขึ้นทะเบียนเรียบร้อย</p>
                <h3 class="text-3xl font-bold text-green-600">{{ summary.completed }}</h3>
                <p class="text-xs text-green-600 mt-1">{{ summary.completed_rate }}%</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-check-circle text-green-500 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- KPI Cards Row 2 - Training Results -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <!-- Theory Training -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-gray-700 font-medium">ผลอบรมทฤษฎี</h4>
            <span class="text-2xl font-bold text-blue-600">{{ summary.theory_rate }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-blue-600 h-3 rounded-full" style="width: {{ summary.theory_rate }}%"></div>
        </div>
        <div class="flex justify-between text-sm mt-2">
            <span class="text-blue-600"><i class="fas fa-users"></i> เข้าอบรม {{ summary.theory_pass + summary.theory_fail }}</span>
        </div>
        <div class="flex justify-between text-sm mt-1">
            <span class="text-green-600"><i class="fas fa-check"></i> ผ่าน {{ summary.theory_pass }}</span>
            <span class="text-red-600"><i class="fas fa-times"></i> ไม่ผ่าน {{ summary.theory_fail }}</span>
        </div>
    </div>
    
    <!-- OJT -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-gray-700 font-medium">ผล OJT</h4>
            <span class="text-2xl font-bold text-purple-600">{{ summary.ojt_rate }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-purple-600 h-3 rounded-full" style="width: {{ summary.ojt_rate }}%"></div>
        </div>
        <div class="flex justify-between text-sm mt-2">
            <span class="text-purple-600"><i class="fas fa-users"></i> เข้า OJT {{ summary.ojt_pass + summary.ojt_fail }}</span>
        </div>
        <div class="flex justify-between text-sm mt-1">
            <span class="text-green-600"><i class="fas fa-check"></i> ผ่าน {{ summary.ojt_pass }}</span>
            <span class="text-red-600"><i class="fas fa-times"></i> ไม่ผ่าน {{ summary.ojt_fail }}</span>
        </div>
    </div>
    
    <!-- Average SLA -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <div class="flex items-center justify-between mb-3">
            <h4 class="text-gray-700 font-medium">SLA เฉลี่ยรวม</h4>
            <span class="text-2xl font-bold {% if summary.avg_sla_total <= 45 %}text-green-600{% elif summary.avg_sla_total <= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                {{ summary.avg_sla_total }} วัน
            </span>
        </div>
        <div class="text-sm text-gray-500">
            <i class="fas fa-info-circle"></i> ระยะเวลาเฉลี่ยจากเริ่มต้นจนขึ้นทะเบียนสำเร็จ
        </div>
    </div>
</div>

<!-- SLA by Step Section -->
<div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-list-ol text-blue-500 mr-2"></i>SLA แต่ละขั้นตอน (8 ขั้นตอน)
    </h3>
    <div class="overflow-x-auto">
        <div class="flex gap-3 pb-2">
            {% for step in sla_steps %}
            {% set avg_sla_ceil = (step.avg_sla | round(0, 'ceil')) | int %}
            <div class="flex-shrink-0 w-40 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border">
                <div class="text-center">
                    <div class="text-xs text-gray-500 mb-1">{{ loop.index }}. {{ step.name }}</div>
                    <div class="text-2xl font-bold {% if avg_sla_ceil <= 7 %}text-green-600{% elif avg_sla_ceil <= 14 %}text-yellow-600{% else %}text-red-600{% endif %}">
                        {{ avg_sla_ceil }}
                    </div>
                    <div class="text-xs text-gray-400">วันเฉลี่ย</div>
                    <div class="text-xs text-green-600 mt-2">
                        <i class="fas fa-check"></i> {{ step.complete }} Complete
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Monthly Trend Line Chart - Total vs Completed -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-line text-purple-500 mr-2"></i>Trend รายเดือน: ลงทะเบียน vs ขึ้นทะเบียนสำเร็จ
        </h3>
        <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
    
    <!-- Monthly Area Trend Chart - Total by Area -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-trophy text-orange-500 mr-2"></i>Overall Success Rate Ranking
        </h3>
        <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="areaSuccessRateChart"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Monthly Trend Chart -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-line text-blue-500 mr-2"></i>จำนวนช่างรายเดือน
        </h3>
        <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>
    
    <!-- Status Pie Chart -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-pie text-green-500 mr-2"></i>สถานะการลงทะเบียน
        </h3>
        <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<!-- Area Step Summary Table -->
<div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-table text-indigo-500 mr-2"></i>ตารางสรุป: จำนวนช่างแยกตามพื้นที่และสถานะ
    </h3>
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="areaStepSummaryTable">
            <thead class="bg-gray-800 text-white">
                <tr>
                    <th class="px-4 py-3 text-left font-medium">พื้นที่ (Area)</th>
                    <th class="px-4 py-3 text-center font-medium">ลงทะเบียน<br>(คน)</th>
                    <th class="px-4 py-3 text-center font-medium bg-green-700">Completed<br>(เสร็จสิ้น)</th>
                    <th class="px-4 py-3 text-center font-medium bg-gray-600">Cancel<br>(ยกเลิก)</th>
                    <th class="px-4 py-3 text-center font-medium bg-red-700">Closed<br>(ปิดงาน)</th>
                    <th class="px-4 py-3 text-center font-medium bg-yellow-600">Onprocess<br>(ดำเนินการ)</th>
                    <!-- Dynamic Onprocess sub-status columns from unique statuses -->
                    {% if area_step_summary|length > 0 %}
                    {% for status_name in area_step_summary[0].unique_onprocess_statuses %}
                    <th class="px-3 py-3 text-center font-medium bg-amber-500 onprocess-sub-col hidden text-xs" data-substatus="{{ loop.index0 }}">{{ status_name }}</th>
                    {% endfor %}
                    {% endif %}
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                <!-- Total Row -->
                <tr class="bg-gray-100 font-bold border-b-2 border-gray-400">
                    <td class="px-4 py-3 text-gray-800">Total</td>
                    <td class="px-4 py-3 text-center">{{ area_step_summary|sum(attribute='total') }}</td>
                    <td class="px-4 py-3 text-center text-green-600">{{ area_step_summary|sum(attribute='completed') }}</td>
                    <td class="px-4 py-3 text-center text-gray-600">{{ area_step_summary|sum(attribute='cancel') }}</td>
                    <td class="px-4 py-3 text-center text-red-600">{{ area_step_summary|sum(attribute='closed') }}</td>
                    <td class="px-4 py-3 text-center text-yellow-600">{{ area_step_summary|sum(attribute='onprocess') }}</td>
                    {% if area_step_summary|length > 0 %}
                    {% for col_idx in range(area_step_summary[0].onprocess_columns|length) %}
                    {% set col_total = [] %}
                    {% for item in area_step_summary %}
                    {% if item.onprocess_columns[col_idx].count %}
                    {% set _ = col_total.append(item.onprocess_columns[col_idx].count) %}
                    {% endif %}
                    {% endfor %}
                    <td class="px-3 py-3 text-center onprocess-sub-col hidden text-amber-700 font-medium">{{ col_total|sum }}</td>
                    {% endfor %}
                    {% endif %}
                </tr>
                {% for item in area_step_summary %}
                {% set area_idx = loop.index0 %}
                <tr class="hover:bg-gray-50 area-main-row" data-area-idx="{{ area_idx }}">
                    <td class="px-4 py-3 font-medium text-gray-800">{{ item.area }}</td>
                    <td class="px-4 py-3 text-center font-medium">{{ item.total }}</td>
                    <!-- Completed -->
                    <td class="px-4 py-3 text-center">
                        {% if item.completed > 0 %}
                        <button class="toggle-status-details text-green-600 font-medium hover:bg-green-100 px-2 py-1 rounded cursor-pointer" 
                                data-target="completed-{{ area_idx }}">
                            {{ item.completed }}<i class="fas fa-caret-right ml-2 toggle-icon"></i>
                        </button>
                        {% else %}
                        <span class="text-gray-400">0</span>
                        {% endif %}
                    </td>
                    <!-- Cancel -->
                    <td class="px-4 py-3 text-center">
                        {% if item.cancel > 0 %}
                        <button class="toggle-status-details text-gray-600 font-medium hover:bg-gray-200 px-2 py-1 rounded cursor-pointer" 
                                data-target="cancel-{{ area_idx }}">
                            {{ item.cancel }}<i class="fas fa-caret-right ml-2 toggle-icon"></i>
                        </button>
                        {% else %}
                        <span class="text-gray-400">0</span>
                        {% endif %}
                    </td>
                    <!-- Closed -->
                    <td class="px-4 py-3 text-center">
                        {% if item.closed > 0 %}
                        <button class="toggle-status-details text-red-600 font-medium hover:bg-red-100 px-2 py-1 rounded cursor-pointer" 
                                data-target="closed-{{ area_idx }}">
                            {{ item.closed }}<i class="fas fa-caret-right ml-2 toggle-icon"></i>
                        </button>
                        {% else %}
                        <span class="text-gray-400">0</span>
                        {% endif %}
                    </td>
                    <!-- Onprocess -->
                    <td class="px-4 py-3 text-center">
                        {% if item.onprocess > 0 %}
                        <button class="toggle-onprocess-expand text-yellow-600 font-medium hover:bg-yellow-100 px-2 py-1 rounded cursor-pointer" 
                                data-area-idx="{{ area_idx }}"
                                data-breakdown='{{ item.onprocess_breakdown | tojson }}'>
                            {{ item.onprocess }}<i class="fas fa-caret-right ml-2 toggle-icon-onprocess"></i>
                        </button>
                        {% else %}
                        <span class="text-gray-400">0</span>
                        {% endif %}
                    </td>
                    <!-- Onprocess sub-status cells (using onprocess_columns for consistency) -->
                    {% for col_idx in range(item.onprocess_columns|length) %}
                    {% set col = item.onprocess_columns[col_idx] %}
                    <td class="px-3 py-3 text-center onprocess-sub-col hidden" data-area="{{ area_idx }}">
                        {% if col.count > 0 %}
                        <button class="toggle-technician-list text-amber-700 font-medium hover:bg-amber-100 px-2 py-1 rounded cursor-pointer text-xs"
                                data-target="onprocess-{{ area_idx }}-{{ col_idx }}">
                            {{ col.count }}<i class="fas fa-caret-right ml-1 toggle-icon-sub"></i>
                        </button>
                        {% else %}
                        <span class="text-gray-400">0</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                
                <!-- Onprocess technician detail rows (hidden) - ใช้ enumerate-style index -->
                {% for col_idx in range(item.onprocess_columns|length) %}
                {% set col = item.onprocess_columns[col_idx] %}
                {% if col.count > 0 %}
                <tr class="technician-detail-row bg-amber-50 hidden" id="onprocess-{{ area_idx }}-{{ col_idx }}">
                    <td colspan="20" class="px-6 py-3">
                        <div class="text-sm">
                            <div class="font-medium text-amber-800 mb-2">
                                <i class="fas fa-users mr-2"></i>{{ col.status }} ({{ col.count }} คน)
                            </div>
                            <table class="min-w-full bg-white rounded border">
                                <thead class="bg-amber-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-amber-800">#</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-amber-800">รหัส Depot</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-amber-800">ชื่อ Depot</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-amber-800">ชื่อช่าง</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    {% for tech in col.details %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-3 py-2 text-xs text-gray-600">{{ loop.index }}</td>
                                        <td class="px-3 py-2 text-xs text-gray-800">{{ tech.depot_code }}</td>
                                        <td class="px-3 py-2 text-xs text-gray-800">{{ tech.depot_name }}</td>
                                        <td class="px-3 py-2 text-xs text-gray-800 font-medium">{{ tech.full_name_th }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
                
                <!-- Detail rows for other status (Completed, Cancel, Closed) -->
                
                <!-- Completed Breakdown -->
                {% if item.completed_breakdown|length > 0 %}
                <tr class="status-detail-row bg-green-50 hidden" id="completed-{{ area_idx }}">
                    <td colspan="14" class="px-6 py-3">
                        <div class="text-sm">
                            <div class="font-medium text-green-800 mb-3">
                                <i class="fas fa-check-circle mr-2"></i>Completed - สถานะย่อย ({{ item.completed }} คน)
                            </div>
                            <div class="space-y-2">
                                {% for sub in item.completed_breakdown %}
                                <div class="border border-green-200 rounded-lg overflow-hidden">
                                    <button class="toggle-technician-list w-full flex items-center justify-between px-4 py-2 bg-green-100 hover:bg-green-200 transition cursor-pointer"
                                            data-target="completed-{{ area_idx }}-{{ loop.index0 }}">
                                        <span class="font-medium text-green-800">{{ sub.status }}</span>
                                        <span class="flex items-center gap-2">
                                            <span class="bg-green-600 text-white px-2 py-1 rounded text-xs">{{ sub.count }} คน</span>
                                            <i class="fas fa-chevron-down toggle-icon-sub text-green-600"></i>
                                        </span>
                                    </button>
                                    <div class="technician-list hidden bg-white" id="completed-{{ area_idx }}-{{ loop.index0 }}">
                                        <table class="min-w-full">
                                            <thead class="bg-green-50">
                                                <tr>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-green-700">#</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-green-700">รหัส Depot</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-green-700">ชื่อ Depot</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-green-700">ชื่อช่าง</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100">
                                                {% for tech in sub.details %}
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-3 py-2 text-xs text-gray-600">{{ loop.index }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800">{{ tech.depot_code }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800">{{ tech.depot_name }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800 font-medium">{{ tech.full_name_th }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                
                <!-- Cancel Breakdown -->
                {% if item.cancel_breakdown|length > 0 %}
                <tr class="status-detail-row bg-gray-100 hidden" id="cancel-{{ area_idx }}">
                    <td colspan="14" class="px-6 py-3">
                        <div class="text-sm">
                            <div class="font-medium text-gray-700 mb-3">
                                <i class="fas fa-ban mr-2"></i>Cancel - สถานะย่อย ({{ item.cancel }} คน)
                            </div>
                            <div class="space-y-2">
                                {% for sub in item.cancel_breakdown %}
                                <div class="border border-gray-300 rounded-lg overflow-hidden">
                                    <button class="toggle-technician-list w-full flex items-center justify-between px-4 py-2 bg-gray-200 hover:bg-gray-300 transition cursor-pointer"
                                            data-target="cancel-{{ area_idx }}-{{ loop.index0 }}">
                                        <span class="font-medium text-gray-700">{{ sub.status }}</span>
                                        <span class="flex items-center gap-2">
                                            <span class="bg-gray-600 text-white px-2 py-1 rounded text-xs">{{ sub.count }} คน</span>
                                            <i class="fas fa-chevron-down toggle-icon-sub text-gray-600"></i>
                                        </span>
                                    </button>
                                    <div class="technician-list hidden bg-white" id="cancel-{{ area_idx }}-{{ loop.index0 }}">
                                        <table class="min-w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600">#</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600">รหัส Depot</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600">ชื่อ Depot</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600">ชื่อช่าง</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100">
                                                {% for tech in sub.details %}
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-3 py-2 text-xs text-gray-600">{{ loop.index }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800">{{ tech.depot_code }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800">{{ tech.depot_name }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800 font-medium">{{ tech.full_name_th }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                
                <!-- Closed Breakdown -->
                {% if item.closed_breakdown|length > 0 %}
                <tr class="status-detail-row bg-red-50 hidden" id="closed-{{ area_idx }}">
                    <td colspan="14" class="px-6 py-3">
                        <div class="text-sm">
                            <div class="font-medium text-red-800 mb-3">
                                <i class="fas fa-times-circle mr-2"></i>Closed - สถานะย่อย ({{ item.closed }} คน)
                            </div>
                            <div class="space-y-2">
                                {% for sub in item.closed_breakdown %}
                                <div class="border border-red-200 rounded-lg overflow-hidden">
                                    <button class="toggle-technician-list w-full flex items-center justify-between px-4 py-2 bg-red-100 hover:bg-red-200 transition cursor-pointer"
                                            data-target="closed-{{ area_idx }}-{{ loop.index0 }}">
                                        <span class="font-medium text-red-800">{{ sub.status }}</span>
                                        <span class="flex items-center gap-2">
                                            <span class="bg-red-600 text-white px-2 py-1 rounded text-xs">{{ sub.count }} คน</span>
                                            <i class="fas fa-chevron-down toggle-icon-sub text-red-600"></i>
                                        </span>
                                    </button>
                                    <div class="technician-list hidden bg-white" id="closed-{{ area_idx }}-{{ loop.index0 }}">
                                        <table class="min-w-full">
                                            <thead class="bg-red-50">
                                                <tr>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-red-700">#</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-red-700">รหัส Depot</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-red-700">ชื่อ Depot</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-red-700">ชื่อช่าง</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100">
                                                {% for tech in sub.details %}
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-3 py-2 text-xs text-gray-600">{{ loop.index }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800">{{ tech.depot_code }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800">{{ tech.depot_name }}</td>
                                                    <td class="px-3 py-2 text-xs text-gray-800 font-medium">{{ tech.full_name_th }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Depot Agent Stats & Top Provinces -->
<div class="flex flex-col lg:flex-row gap-6 mb-6">
    <!-- Depot Agent Stats Table - 65% -->
    <div class="bg-white rounded-xl shadow-sm p-5 w-full lg:w-[65%]">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-building text-purple-500 mr-2"></i>สรุปจำนวนช่างตามตัวแทน
        </h3>
        <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
            <table class="min-w-full text-sm" id="depotAgentTable">
                <thead class="bg-gray-800 text-white sticky top-0">
                    <tr>
                        <th class="px-2 py-2 text-left font-medium text-xs">#</th>
                        <th class="px-2 py-2 text-left font-medium text-xs cursor-pointer hover:bg-gray-700 sortable-header" data-sort="area">Area <i class="fas fa-sort text-gray-400 ml-1"></i></th>
                        <th class="px-2 py-2 text-left font-medium text-xs cursor-pointer hover:bg-gray-700 sortable-header" data-sort="depot_code">รหัส <i class="fas fa-sort text-gray-400 ml-1"></i></th>
                        <th class="px-2 py-2 text-left font-medium text-xs cursor-pointer hover:bg-gray-700 sortable-header" data-sort="depot_name" style="max-width: 150px;">ตัวแทน <i class="fas fa-sort text-gray-400 ml-1"></i></th>
                        <th class="px-2 py-2 text-left font-medium text-xs cursor-pointer hover:bg-gray-700 sortable-header" data-sort="province">จังหวัด <i class="fas fa-sort text-gray-400 ml-1"></i></th>
                        <th class="px-2 py-2 text-center font-medium text-xs cursor-pointer hover:bg-gray-700 sortable-header" data-sort="total">ลงทะเบียน <i class="fas fa-sort text-gray-400 ml-1"></i></th>
                        <th class="px-2 py-2 text-center font-medium text-xs cursor-pointer hover:bg-gray-700 bg-green-700 sortable-header" data-sort="completed">สำเร็จ <i class="fas fa-sort text-gray-400 ml-1"></i></th>
                        <th class="px-2 py-2 text-center font-medium text-xs cursor-pointer hover:bg-gray-700 bg-blue-700 sortable-header" data-sort="success_rate">% <i class="fas fa-sort text-gray-400 ml-1"></i></th>
                    </tr>
                    <!-- Total Row -->
                    <tr class="bg-gray-100 font-bold border-b-2 border-gray-400">
                        <td class="px-2 py-2 text-gray-800 text-xs" colspan="5">Total ({{ depot_agents|length }} ตัวแทน)</td>
                        <td class="px-2 py-2 text-center text-gray-800 text-xs">{{ depot_agents|sum(attribute='total') }}</td>
                        <td class="px-2 py-2 text-center text-green-600 text-xs">{{ depot_agents|sum(attribute='completed') }}</td>
                        <td class="px-2 py-2 text-center text-xs">
                            {% set total_reg = depot_agents|sum(attribute='total') %}
                            {% set total_comp = depot_agents|sum(attribute='completed') %}
                            <span class="px-1 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                {{ ((total_comp / total_reg * 100) if total_reg > 0 else 0)|round(1) }}%
                            </span>
                        </td>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="depotAgentTableBody">
                    {% for agent in depot_agents %}
                    <tr class="hover:bg-gray-50" data-area="{{ agent.area }}" data-depot_code="{{ agent.depot_code }}" data-depot_name="{{ agent.depot_name }}" data-province="{{ agent.province }}" data-total="{{ agent.total }}" data-completed="{{ agent.completed }}" data-success_rate="{{ agent.success_rate }}">
                        <td class="px-2 py-1 text-gray-600 text-xs row-index">{{ loop.index }}</td>
                        <td class="px-2 py-1 text-gray-800 font-medium text-xs">{{ agent.area }}</td>
                        <td class="px-2 py-1 text-gray-600 text-xs">{{ agent.depot_code }}</td>
                        <td class="px-2 py-1 text-gray-800 text-xs truncate" style="max-width: 150px;" title="{{ agent.depot_name }}">{{ agent.depot_name }}</td>
                        <td class="px-2 py-1 text-gray-600 text-xs">{{ agent.province }}</td>
                        <td class="px-2 py-1 text-center font-medium text-xs">{{ agent.total }}</td>
                        <td class="px-2 py-1 text-center text-green-600 font-medium text-xs">{{ agent.completed }}</td>
                        <td class="px-2 py-1 text-center">
                            <span class="px-1 py-0.5 rounded text-xs font-medium 
                                {% if agent.success_rate >= 80 %}bg-green-100 text-green-800
                                {% elif agent.success_rate >= 50 %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ agent.success_rate }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Top Provinces - 35% -->
    <div class="bg-white rounded-xl shadow-sm p-5 w-full lg:w-[35%]">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-city text-teal-500 mr-2"></i>Top 10 จังหวัด
        </h3>
        <div class="space-y-2">
            {% for prov in provinces[:10] %}
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                <span class="text-gray-700">{{ prov.province }}</span>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500">{{ prov.total }} ลงทะเบียน</span>
                    <span class="text-sm font-medium text-green-600">{{ prov.completed }} สำเร็จ</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== Onprocess Expand to Right (แสดงสถานะย่อยเป็นคอลัมน์ทางขวา) =====
    let onprocessExpanded = false;
    
    // ไม่ต้อง update header names เพราะมาจาก server แล้ว
    
    document.querySelectorAll('.toggle-onprocess-expand').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const icon = this.querySelector('.toggle-icon-onprocess');
            
            if (!onprocessExpanded) {
                // Expand - แสดงคอลัมน์ทางขวาทั้งหมด
                onprocessExpanded = true;
                
                // แสดงทุก sub-columns
                document.querySelectorAll('.onprocess-sub-col').forEach(function(col) {
                    col.classList.remove('hidden');
                });
                
                // เปลี่ยน icon ทุกปุ่ม
                document.querySelectorAll('.toggle-icon-onprocess').forEach(function(ic) {
                    ic.classList.remove('fa-caret-right');
                    ic.classList.add('fa-caret-down');
                });
            } else {
                // Collapse - ซ่อนคอลัมน์ทางขวา
                onprocessExpanded = false;
                
                // ซ่อน sub-status columns
                document.querySelectorAll('.onprocess-sub-col').forEach(function(col) {
                    col.classList.add('hidden');
                });
                
                // ซ่อน technician detail rows
                document.querySelectorAll('.technician-detail-row').forEach(function(row) {
                    row.classList.add('hidden');
                });
                
                // เปลี่ยน icon กลับ
                document.querySelectorAll('.toggle-icon-onprocess').forEach(function(ic) {
                    ic.classList.remove('fa-caret-down');
                    ic.classList.add('fa-caret-right');
                });
                
                // reset sub icons
                document.querySelectorAll('.onprocess-sub-col .toggle-icon-sub').forEach(function(ic) {
                    ic.classList.remove('fa-caret-down');
                    ic.classList.add('fa-caret-right');
                });
            }
        });
    });
    
    // ===== Technician Detail Row Toggle (สำหรับ Onprocess sub-status) - ใช้ Event Delegation =====
    document.addEventListener('click', function(e) {
        // ตรวจสอบว่าคลิกที่ปุ่มใน onprocess-sub-col หรือไม่
        const btn = e.target.closest('.onprocess-sub-col .toggle-technician-list');
        if (btn) {
            e.preventDefault();
            e.stopPropagation();
            const targetId = btn.getAttribute('data-target');
            const targetRow = document.getElementById(targetId);
            const icon = btn.querySelector('.toggle-icon-sub');
            
            if (targetRow) {
                if (targetRow.classList.contains('hidden')) {
                    targetRow.classList.remove('hidden');
                    if (icon) {
                        icon.classList.remove('fa-caret-right');
                        icon.classList.add('fa-caret-down');
                    }
                } else {
                    targetRow.classList.add('hidden');
                    if (icon) {
                        icon.classList.remove('fa-caret-down');
                        icon.classList.add('fa-caret-right');
                    }
                }
            } else {
                // Fallback: ลองหา row ด้วย attribute selector
                const allDetailRows = document.querySelectorAll('.technician-detail-row');
                allDetailRows.forEach(function(row) {
                    if (row.id === targetId) {
                        row.classList.toggle('hidden');
                    }
                });
            }
        }
    });

    // ===== Status Details Expand/Collapse (สำหรับ Completed, Cancel, Closed) =====
    document.querySelectorAll('.toggle-status-details').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const targetRow = document.getElementById(targetId);
            const icon = this.querySelector('.toggle-icon');
            
            if (targetRow) {
                if (targetRow.classList.contains('hidden')) {
                    // Expand
                    targetRow.classList.remove('hidden');
                    icon.classList.remove('fa-caret-right');
                    icon.classList.add('fa-caret-down');
                } else {
                    // Collapse
                    targetRow.classList.add('hidden');
                    icon.classList.remove('fa-caret-down');
                    icon.classList.add('fa-caret-right');
                }
            }
        });
    });

    // ===== Technician List Expand/Collapse (สำหรับสถานะย่อย Completed, Cancel, Closed) =====
    // ใช้สำหรับปุ่มที่ไม่ได้อยู่ใน onprocess-sub-col
    document.querySelectorAll('.toggle-technician-list:not(.onprocess-sub-col .toggle-technician-list)').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const targetDiv = document.getElementById(targetId);
            const icon = this.querySelector('.toggle-icon-sub');
            
            if (targetDiv) {
                if (targetDiv.classList.contains('hidden')) {
                    // Expand
                    targetDiv.classList.remove('hidden');
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                } else {
                    // Collapse
                    targetDiv.classList.add('hidden');
                    if (icon) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                }
            }
        });
    });

    // ===== Area Table Expand/Collapse =====
    document.querySelectorAll('.toggle-breakdown').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const targetRow = document.getElementById(targetId);
            const icon = this.querySelector('.toggle-icon');
            
            if (targetRow) {
                if (targetRow.classList.contains('hidden')) {
                    // Expand
                    targetRow.classList.remove('hidden');
                    icon.classList.remove('fa-plus-circle');
                    icon.classList.add('fa-minus-circle');
                } else {
                    // Collapse
                    targetRow.classList.add('hidden');
                    icon.classList.remove('fa-minus-circle');
                    icon.classList.add('fa-plus-circle');
                }
            }
        });
    });

    // Store chart instances
    let chartInstances = {};
    
    // Helper to create chart safely
    function createChart(canvasId, config) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        
        // Destroy existing chart on this canvas
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        
        const ctx = canvas.getContext('2d');
        config.options = config.options || {};
        config.options.animation = false;
        config.options.responsive = true;
        config.options.maintainAspectRatio = false;
        
        chartInstances[canvasId] = new Chart(ctx, config);
        return chartInstances[canvasId];
    }

    // ===== กราฟที่ 1: Trend รายเดือน - ลงทะเบียน vs ขึ้นทะเบียนสำเร็จ =====
    const monthLabels = [{% for m in monthly %}'{{ m.month }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const monthlyTotals = [{% for m in monthly %}{{ m.total }}{% if not loop.last %},{% endif %}{% endfor %}];
    const monthlyCompleted = [{% for m in monthly %}{{ m.completed }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    // Custom plugin สำหรับแสดงตัวเลขบนจุดกราฟ
    const trendLabelPlugin = {
        id: 'trendLabelPlugin',
        afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            
            chart.data.datasets.forEach((dataset, datasetIndex) => {
                const meta = chart.getDatasetMeta(datasetIndex);
                if (!meta.hidden) {
                    meta.data.forEach((point, index) => {
                        const value = dataset.data[index];
                        
                        ctx.save();
                        ctx.font = 'bold 12px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        
                        let displayText = value.toString();
                        
                        // กำหนดสีและข้อความตามชุดข้อมูล
                        if (datasetIndex === 0) {
                            // ลงทะเบียน - สีน้ำเงิน
                            ctx.fillStyle = '#3B82F6';
                        } else if (datasetIndex === 1) {
                            // ขึ้นทะเบียนสำเร็จ - สีเขียว + แสดง %
                            ctx.fillStyle = '#10B981';
                            const totalRegistered = monthlyTotals[index];
                            const percentage = totalRegistered > 0 ? (value / totalRegistered * 100).toFixed(1) : 0;
                            displayText = value + ' (' + percentage + '%)';
                        }
                        
                        // แสดงตัวเลขเหนือจุด (ลบ 15 pixels จาก y position)
                        ctx.fillText(displayText, point.x, point.y - 15);
                        ctx.restore();
                    });
                }
            });
        }
    };
    
    createChart('trendChart', {
        type: 'line',
        plugins: [trendLabelPlugin],
        data: {
            labels: monthLabels,
            datasets: [
                {
                    label: 'ลงทะเบียน',
                    data: monthlyTotals,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#3B82F6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                },
                {
                    label: 'ขึ้นทะเบียนสำเร็จ',
                    data: monthlyCompleted,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }
            ]
        },
        options: {
            layout: {
                padding: { top: 25 }
            },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                datalabels: {
                    display: false  // ปิด datalabels plugin เพื่อไม่ให้แสดงตัวเลขสีดำทับ
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 10
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });

    // ===== กราฟที่ 2: Overall Success Rate Ranking (แท่งแนวนอน) =====
    // จัดเรียงพื้นที่ตาม success_rate จากมากไปน้อย
    const areaRankingData = [
        {% for a in areas %}
        { area: '{{ a.area }}', successRate: {{ a.success_rate }}, completed: {{ a.completed }}, total: {{ a.total }} }{% if not loop.last %},{% endif %}
        {% endfor %}
    ].sort((a, b) => b.successRate - a.successRate);
    
    const areaRankingLabels = areaRankingData.map(d => d.area);
    const areaRankingRates = areaRankingData.map(d => d.successRate);
    
    // Custom plugin สำหรับแสดงจำนวนในแท่งและ % ที่ปลายแท่ง
    const areaRankingLabelPlugin = {
        id: 'areaRankingLabelPlugin',
        afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            const meta = chart.getDatasetMeta(0);
            const chartArea = chart.chartArea;
            
            meta.data.forEach((bar, index) => {
                const data = areaRankingData[index];
                const barWidth = bar.x - bar.base;
                
                ctx.save();
                ctx.textBaseline = 'middle';
                
                // คำนวณตำแหน่งจริงของแท่ง (bar.base = ตำแหน่งเริ่มต้น, bar.x = ตำแหน่งสิ้นสุด)
                const textToDisplay = data.completed + '/' + data.total;
                
                // วัดความกว้างของข้อความ
                ctx.font = 'bold 10px sans-serif';
                const textWidth = ctx.measureText(textToDisplay).width;
                
                // ถ้าแท่งกว้างพอ แสดงตัวเลขในแท่ง (สีขาว)
                // ถ้าแท่งแคบเกินไป แสดงตัวเลขนอกแท่ง (สีดำ)
                if (barWidth > textWidth + 10) {
                    // แสดงในแท่ง - กึ่งกลางระหว่าง base กับ x
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    const centerX = bar.base + (barWidth / 2);
                    ctx.fillText(textToDisplay, centerX, bar.y);
                } else {
                    // แสดงนอกแท่ง (ด้านซ้ายของแกน Y)
                    ctx.fillStyle = '#1F2937';
                    ctx.textAlign = 'right';
                    ctx.fillText(textToDisplay, bar.base - 5, bar.y);
                }
                
                // แสดง % ที่ปลายแท่ง (สีดำ) - ตรวจสอบว่าไม่เกินขอบ chart
                ctx.fillStyle = '#1F2937';
                ctx.font = 'bold 11px sans-serif';
                ctx.textAlign = 'left';
                const percentText = data.successRate.toFixed(1) + '%';
                const percentX = Math.min(bar.x + 5, chartArea.right - ctx.measureText(percentText).width - 5);
                ctx.fillText(percentText, percentX, bar.y);
                
                ctx.restore();
            });
        }
    };
    
    createChart('areaSuccessRateChart', {
        type: 'bar',
        plugins: [areaRankingLabelPlugin],
        data: {
            labels: areaRankingLabels,
            datasets: [{
                label: 'Success Rate (%)',
                data: areaRankingRates,
                backgroundColor: areaRankingRates.map((rate, idx) => {
                    // ไล่สีจากเขียว (สูงสุด) ไปเหลือง/แดง (ต่ำสุด)
                    if (rate >= 70) return '#10B981';  // เขียว
                    if (rate >= 50) return '#F59E0B';  // เหลือง
                    return '#EF4444';  // แดง
                }),
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            indexAxis: 'y',  // แท่งแนวนอน
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            const data = areaRankingData[idx];
                            return [
                                'Success Rate: ' + data.successRate.toFixed(1) + '%',
                                'สำเร็จ: ' + data.completed + ' / ' + data.total + ' คน'
                            ];
                        }
                    }
                },
                datalabels: {
                    display: false  // ปิด datalabels plugin ใช้ custom plugin แทน
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });

    // Status by Area Stacked Bar Chart
    const areaLabels = [{% for a in areas %}'{{ a.area }}'{% if not loop.last %},{% endif %}{% endfor %}];
    const areaCompleted = [{% for a in areas %}{{ a.completed }}{% if not loop.last %},{% endif %}{% endfor %}];
    const areaOnprocess = [{% for a in areas %}{{ a.onprocess }}{% if not loop.last %},{% endif %}{% endfor %}];
    const areaClosed = [{% for a in areas %}{{ a.closed }}{% if not loop.last %},{% endif %}{% endfor %}];
    const areaCancel = [{% for a in areas %}{{ a.cancel }}{% if not loop.last %},{% endif %}{% endfor %}];
    const areaTotals = [{% for a in areas %}{{ a.total }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    // Custom plugin สำหรับแสดง total บน top ของ stack
    const stackTotalPlugin = {
        id: 'stackTotalPlugin',
        afterDatasetsDraw: function(chart) {
            const ctx = chart.ctx;
            const datasets = chart.data.datasets;
            
            chart.data.labels.forEach((label, i) => {
                let total = 0;
                let maxY = null;
                
                datasets.forEach((dataset, j) => {
                    const meta = chart.getDatasetMeta(j);
                    if (!meta.hidden) {
                        total += dataset.data[i] || 0;
                        const bar = meta.data[i];
                        if (bar && (maxY === null || bar.y < maxY)) {
                            maxY = bar.y;
                        }
                    }
                });
                
                if (total > 0 && maxY !== null) {
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.font = 'bold 12px sans-serif';
                    ctx.fillStyle = '#374151';
                    ctx.fillText(total, chart.getDatasetMeta(0).data[i].x, maxY - 5);
                    ctx.restore();
                }
            });
        }
    };
    
    new Chart(document.getElementById('statusChart'), {
        type: 'bar',
        plugins: [ChartDataLabels, stackTotalPlugin],
        data: {
            labels: areaLabels,
            datasets: [
                {
                    label: 'ขึ้นทะเบียนเรียบร้อย',
                    data: areaCompleted,
                    backgroundColor: '#10B981',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'อยู่ระหว่างดำเนินการ',
                    data: areaOnprocess,
                    backgroundColor: '#F59E0B',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'ปิดงาน',
                    data: areaClosed,
                    backgroundColor: '#EF4444',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'ยกเลิก',
                    data: areaCancel,
                    backgroundColor: '#6B7280',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true }
            },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        afterTitle: function(context) {
                            const idx = context[0].dataIndex;
                            return 'รวม: ' + areaTotals[idx] + ' คน';
                        }
                    }
                }
            }
        }
    });

    // Monthly Trend Chart - ข้อมูลยอดรวมแต่ละเดือน
    const barMonthlyTotals = [{% for m in monthly %}{{ m.total }}{% if not loop.last %},{% endif %}{% endfor %}];
    const barMonthlyCompleted = [{% for m in monthly %}{{ m.completed }}{% if not loop.last %},{% endif %}{% endfor %}];
    const barMonthlyOnprocess = [{% for m in monthly %}{{ m.onprocess }}{% if not loop.last %},{% endif %}{% endfor %}];
    const barMonthlyClosed = [{% for m in monthly %}{{ m.closed }}{% if not loop.last %},{% endif %}{% endfor %}];
    const barMonthlyCancel = [{% for m in monthly %}{{ m.cancel }}{% if not loop.last %},{% endif %}{% endfor %}];
    
    createChart('monthlyChart', {
        type: 'bar',
        data: {
            labels: [{% for m in monthly %}'{{ m.month }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [
                {
                    label: 'ขึ้นทะเบียนเรียบร้อย',
                    data: barMonthlyCompleted,
                    backgroundColor: '#10B981',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'อยู่ระหว่างดำเนินการ',
                    data: barMonthlyOnprocess,
                    backgroundColor: '#F59E0B',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'ปิดงาน',
                    data: barMonthlyClosed,
                    backgroundColor: '#EF4444',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                },
                {
                    label: 'ยกเลิก',
                    data: barMonthlyCancel,
                    backgroundColor: '#6B7280',
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: function(value) { return value > 0 ? value : ''; }
                    }
                }
            ]
        },
        options: {
            layout: {
                padding: { top: 25 }
            },
            plugins: { 
                legend: { position: 'bottom' },
                datalabels: { display: true }
            },
            scales: { 
                x: { stacked: true }, 
                y: { 
                    stacked: true,
                    afterFit: function(scaleInstance) {
                        scaleInstance.paddingTop = 25;
                    }
                } 
            }
        },
        plugins: [{
            // Custom plugin เพื่อแสดงยอดรวมบนแท่ง
            id: 'totalLabels',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                const datasets = chart.data.datasets;
                const meta = chart.getDatasetMeta(datasets.length - 1);
                
                ctx.save();
                ctx.font = 'bold 13px sans-serif';
                ctx.fillStyle = '#1F2937';
                ctx.textAlign = 'center';
                
                meta.data.forEach((bar, index) => {
                    const total = barMonthlyTotals[index];
                    if (total > 0) {
                        ctx.fillText(total, bar.x, bar.y - 12);
                    }
                });
                ctx.restore();
            }
        }]
    });

    // ===== Depot Agent Table Sorting =====
    let currentSort = { column: 'total', direction: 'desc' };
    
    document.querySelectorAll('.sortable-header').forEach(function(header) {
        header.addEventListener('click', function() {
            const sortColumn = this.getAttribute('data-sort');
            const tbody = document.getElementById('depotAgentTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Toggle direction if same column
            if (currentSort.column === sortColumn) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = sortColumn;
                currentSort.direction = 'asc';
            }
            
            // Update icons
            document.querySelectorAll('.sortable-header i').forEach(function(icon) {
                icon.className = 'fas fa-sort text-gray-400 ml-1';
            });
            const icon = this.querySelector('i');
            icon.className = currentSort.direction === 'asc' 
                ? 'fas fa-sort-up text-white ml-1' 
                : 'fas fa-sort-down text-white ml-1';
            
            // Sort rows
            rows.sort(function(a, b) {
                let aVal = a.getAttribute('data-' + sortColumn) || '';
                let bVal = b.getAttribute('data-' + sortColumn) || '';
                
                // Check if numeric
                if (['total', 'completed', 'success_rate'].includes(sortColumn)) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Re-append rows and update index
            rows.forEach(function(row, index) {
                row.querySelector('.row-index').textContent = index + 1;
                tbody.appendChild(row);
            });
        });
    });
});
</script>
{% endblock %}
