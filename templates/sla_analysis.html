{% extends "layout.html" %}

{% block title %}วิเคราะห์ SLA - SLA Training{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">วิเคราะห์ SLA แต่ละขั้นตอน</h1>
    <p class="text-gray-600">ดู SLA 6 ขั้นตอน: อบรม → OJT → ทำบัตร → ตรวจความพร้อม → DFlow → ลงทะเบียน</p>
</div>

<!-- SLA Flow Diagram -->
<div class="bg-white rounded-xl shadow-sm p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-project-diagram text-blue-500 mr-2"></i>กระบวนการลงทะเบียนช่าง (6 ขั้นตอน)
    </h3>
    <div class="flex flex-wrap items-center justify-center gap-2 text-sm">
        {% for step in sla_steps %}
        <div class="flex items-center">
            <div class="bg-gradient-to-br {% if step.avg_sla <= 7 %}from-green-100 to-green-200 border-green-300{% elif step.avg_sla <= 14 %}from-yellow-100 to-yellow-200 border-yellow-300{% else %}from-red-100 to-red-200 border-red-300{% endif %} border-2 rounded-xl p-4 text-center min-w-[120px]">
                <div class="text-xs font-medium text-gray-500 mb-1">{{ loop.index }}. {{ step.name }}</div>
                <div class="text-2xl font-bold {% if step.avg_sla <= 7 %}text-green-600{% elif step.avg_sla <= 14 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {{ step.avg_sla }}
                </div>
                <div class="text-xs text-gray-500">วันเฉลี่ย</div>
                <div class="mt-2 text-xs">
                    <span class="text-green-600"><i class="fas fa-check"></i> {{ step.complete }}</span>
                </div>
            </div>
            {% if not loop.last %}
            <div class="text-gray-300 mx-1">
                <i class="fas fa-arrow-right text-xl"></i>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- SLA Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    {% for step in sla_steps %}
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 {% if step.avg_sla <= 7 %}border-green-500{% elif step.avg_sla <= 14 %}border-yellow-500{% else %}border-red-500{% endif %}">
        <div class="flex items-center justify-between mb-3">
            <h4 class="font-medium text-gray-800">{{ step.name }}</h4>
            <span class="text-sm text-gray-400">Step {{ loop.index }}</span>
        </div>
        <div class="grid grid-cols-3 gap-2 text-center">
            <div>
                <div class="text-2xl font-bold {% if step.avg_sla <= 7 %}text-green-600{% elif step.avg_sla <= 14 %}text-yellow-600{% else %}text-red-600{% endif %}">
                    {{ step.avg_sla }}
                </div>
                <div class="text-xs text-gray-500">เฉลี่ย</div>
            </div>
            <div>
                <div class="text-xl font-medium text-gray-600">{{ step.min_sla }}</div>
                <div class="text-xs text-gray-500">ต่ำสุด</div>
            </div>
            <div>
                <div class="text-xl font-medium text-gray-600">{{ step.max_sla }}</div>
                <div class="text-xs text-gray-500">สูงสุด</div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Bottleneck Chart -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-hourglass-half text-orange-500 mr-2"></i>จุดคอขวด (Bottleneck Analysis)
        </h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="bottleneckChart"></canvas>
        </div>
    </div>
    
    <!-- SLA Distribution -->
    <div class="bg-white rounded-xl shadow-sm p-5">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-bar text-purple-500 mr-2"></i>การกระจาย SLA รวม
        </h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="slaDistChart"></canvas>
        </div>
    </div>
</div>

<!-- SLA Comparison Table -->
<div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-table text-indigo-500 mr-2"></i>เปรียบเทียบ SLA แต่ละขั้นตอน
    </h3>
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left font-medium text-gray-600">ขั้นตอน</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">จำนวน</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">Complete</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">SLA เฉลี่ย</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">SLA ต่ำสุด</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">SLA สูงสุด</th>
                    <th class="px-4 py-3 text-center font-medium text-gray-600">สถานะ</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for step in sla_steps %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium mr-2">
                                {{ loop.index }}
                            </span>
                            <span class="font-medium text-gray-800">{{ step.name }}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center text-gray-600">{{ step.total }}</td>
                    <td class="px-4 py-3 text-center text-green-600 font-medium">{{ step.complete }}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-medium {% if step.avg_sla <= 7 %}bg-green-100 text-green-800{% elif step.avg_sla <= 14 %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {{ step.avg_sla }} วัน
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center text-gray-600">{{ step.min_sla }} วัน</td>
                    <td class="px-4 py-3 text-center text-gray-600">{{ step.max_sla }} วัน</td>
                    <td class="px-4 py-3 text-center">
                        {% if step.avg_sla <= 7 %}
                        <span class="text-green-600"><i class="fas fa-check-circle"></i> ดี</span>
                        {% elif step.avg_sla <= 14 %}
                        <span class="text-yellow-600"><i class="fas fa-exclamation-circle"></i> ปานกลาง</span>
                        {% else %}
                        <span class="text-red-600"><i class="fas fa-times-circle"></i> ต้องปรับปรุง</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- SLA Guidelines -->
<div class="bg-white rounded-xl shadow-sm p-5">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
        <i class="fas fa-info-circle text-blue-500 mr-2"></i>เกณฑ์ SLA แนะนำ
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-center mb-2">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                <span class="font-medium text-green-800">ดี (≤7 วัน)</span>
            </div>
            <p class="text-sm text-green-700">ขั้นตอนดำเนินการได้เร็ว ไม่มีปัญหาคอขวด</p>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex items-center mb-2">
                <i class="fas fa-exclamation-circle text-yellow-500 mr-2"></i>
                <span class="font-medium text-yellow-800">ปานกลาง (8-14 วัน)</span>
            </div>
            <p class="text-sm text-yellow-700">อาจมีความล่าช้าบ้าง ควรติดตาม</p>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center mb-2">
                <i class="fas fa-times-circle text-red-500 mr-2"></i>
                <span class="font-medium text-red-800">ต้องปรับปรุง (>14 วัน)</span>
            </div>
            <p class="text-sm text-red-700">มีปัญหาคอขวด ต้องวิเคราะห์และปรับปรุง</p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Store chart instances
    let chartInstances = {};
    
    // Helper to create chart safely
    function createChart(canvasId, config) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        
        // Destroy existing chart on this canvas
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }
        
        const ctx = canvas.getContext('2d');
        config.options = config.options || {};
        config.options.animation = false;
        config.options.responsive = true;
        config.options.maintainAspectRatio = false;
        
        chartInstances[canvasId] = new Chart(ctx, config);
        return chartInstances[canvasId];
    }

    // Bottleneck Chart
    const bottleneckData = [
        {% for item in bottleneck %}
        { step: '{{ item.step }}', days: {{ item.avg_days }} }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    createChart('bottleneckChart', {
        type: 'bar',
        data: {
            labels: bottleneckData.map(d => d.step),
            datasets: [{
                label: 'วันเฉลี่ย',
                data: bottleneckData.map(d => d.days),
                backgroundColor: bottleneckData.map(d => {
                    if (d.days <= 7) return '#10B981';
                    if (d.days <= 14) return '#F59E0B';
                    return '#EF4444';
                }),
                borderRadius: 5
            }]
        },
        options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { title: { display: true, text: 'วัน' } } }
        }
    });

    // SLA Distribution Chart
    createChart('slaDistChart', {
        type: 'bar',
        data: {
            labels: [{% for s in sla_dist %}'{{ s.range }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'จำนวนช่าง',
                data: [{% for s in sla_dist %}{{ s.count }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#10B981', '#34D399', '#F59E0B', '#F97316', '#EF4444'],
                borderRadius: 5
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { y: { title: { display: true, text: 'จำนวนช่าง' } } }
        }
    });
});
</script>
{% endblock %}
