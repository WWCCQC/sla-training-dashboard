{% extends "layout.html" %}

{% block title %}ช่างรอดำเนินการ - SLA Training{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">
        <i class="fas fa-clock text-yellow-500 mr-2"></i>ช่างที่รอดำเนินการ (Onprocess)
    </h1>
    <p class="text-gray-600">รายชื่อช่างที่ยังไม่เสร็จสิ้นกระบวนการ เรียงตาม SLA มากที่สุด</p>
</div>

<!-- Summary Stats -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-yellow-500">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 mb-1">รอดำเนินการทั้งหมด</p>
                <h3 class="text-3xl font-bold text-yellow-600">{{ pending|length }}</h3>
            </div>
            <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                <i class="fas fa-spinner text-yellow-500 text-xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-red-500">
        <div>
            <p class="text-sm text-gray-500 mb-1">SLA เกิน 60 วัน</p>
            <h3 class="text-3xl font-bold text-red-600">
                {{ pending|selectattr('sla_total', 'gt', 60)|list|length }}
            </h3>
        </div>
    </div>
    
    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-orange-500">
        <div>
            <p class="text-sm text-gray-500 mb-1">SLA เกิน 45 วัน</p>
            <h3 class="text-3xl font-bold text-orange-600">
                {{ pending|selectattr('sla_total', 'gt', 45)|list|length }}
            </h3>
        </div>
    </div>
</div>

<!-- Alert Section -->
{% if pending|selectattr('sla_total', 'gt', 60)|list|length > 0 %}
<div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-lg">
    <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
        <div>
            <p class="font-medium text-red-800">มีช่างที่ SLA เกิน 60 วัน!</p>
            <p class="text-sm text-red-600">กรุณาติดตามและดำเนินการโดยเร็ว</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Pending Technicians Table -->
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-3 py-3 text-left font-medium text-gray-600">#</th>
                    <th class="px-3 py-3 text-left font-medium text-gray-600 min-w-[180px]">ชื่อ-นามสกุล</th>
                    <th class="px-3 py-3 text-left font-medium text-gray-600 min-w-[200px]">Depot</th>
                    <th class="px-3 py-3 text-left font-medium text-gray-600">จังหวัด</th>
                    <th class="px-3 py-3 text-left font-medium text-gray-600">พื้นที่</th>
                    <th class="px-3 py-3 text-center font-medium text-gray-600">สถานะปัจจุบัน</th>
                    <th class="px-3 py-3 text-center font-medium text-gray-600 bg-red-50">SLA รวม</th>
                    <!-- SLA Steps - 6 ขั้นตอน (ไม่รวมเอกสาร) -->
                    <th class="px-2 py-3 text-center font-medium text-gray-600 text-xs bg-blue-50">อบรม</th>
                    <th class="px-2 py-3 text-center font-medium text-gray-600 text-xs bg-blue-50">OJT</th>
                    <th class="px-2 py-3 text-center font-medium text-gray-600 text-xs bg-blue-50">บัตร</th>
                    <th class="px-2 py-3 text-center font-medium text-gray-600 text-xs bg-blue-50">ตรวจ</th>
                    <th class="px-2 py-3 text-center font-medium text-gray-600 text-xs bg-blue-50">DFlow</th>
                    <th class="px-2 py-3 text-center font-medium text-gray-600 text-xs bg-blue-50">ลงทะเบียน</th>
                    <th class="px-3 py-3 text-left font-medium text-gray-600">รอบอบรม</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for tech in pending %}
                <tr class="hover:bg-gray-50 {% if tech.sla_total >= 0 and tech.sla_total > 60 %}bg-red-50{% elif tech.sla_total >= 0 and tech.sla_total > 45 %}bg-yellow-50{% endif %}">
                    <td class="px-3 py-2 text-gray-500">{{ loop.index }}</td>
                    <td class="px-3 py-2">
                        <div class="font-medium text-gray-800">{{ tech.name or '-' }}</div>
                        <div class="text-xs text-gray-400">{{ tech.name_en or '' }}</div>
                    </td>
                    <td class="px-3 py-2">
                        <div class="text-gray-800">{{ tech.depot or '-' }}</div>
                        <div class="text-xs text-gray-400">{{ tech.depot_code or '' }}</div>
                    </td>
                    <td class="px-3 py-2 text-gray-600">{{ tech.province or '-' }}</td>
                    <td class="px-3 py-2 text-gray-600 text-xs">{{ tech.area or '-' }}</td>
                    <td class="px-3 py-2 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            {{ tech.status or 'Onprocess' }}
                        </span>
                    </td>
                    <td class="px-3 py-2 text-center bg-red-50">
                        {% if tech.sla_total is not none and tech.sla_total >= 0 %}
                        <span class="text-lg font-bold {% if tech.sla_total > 60 %}text-red-600{% elif tech.sla_total > 45 %}text-orange-600{% else %}text-green-600{% endif %}">
                            {{ tech.sla_total }}
                        </span>
                        <span class="text-xs text-gray-500 block">วัน</span>
                        {% else %}
                        <span class="text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-2 py-2 text-center text-xs bg-blue-50 {% if tech.sla_training is not none and tech.sla_training >= 0 %}{% if tech.sla_training > 7 %}text-red-600 font-medium{% else %}text-green-600 font-medium{% endif %}{% else %}text-gray-400{% endif %}">
                        {% if tech.sla_training is not none and tech.sla_training >= 0 %}{{ tech.sla_training }}{% else %}-{% endif %}
                    </td>
                    <td class="px-2 py-2 text-center text-xs bg-blue-50 {% if tech.sla_ojt is not none and tech.sla_ojt >= 0 %}{% if tech.sla_ojt > 7 %}text-red-600 font-medium{% else %}text-green-600 font-medium{% endif %}{% else %}text-gray-400{% endif %}">
                        {% if tech.sla_ojt is not none and tech.sla_ojt >= 0 %}{{ tech.sla_ojt }}{% else %}-{% endif %}
                    </td>
                    <td class="px-2 py-2 text-center text-xs bg-blue-50 {% if tech.sla_genid is not none and tech.sla_genid >= 0 %}{% if tech.sla_genid > 7 %}text-red-600 font-medium{% else %}text-green-600 font-medium{% endif %}{% else %}text-gray-400{% endif %}">
                        {% if tech.sla_genid is not none and tech.sla_genid >= 0 %}{{ tech.sla_genid }}{% else %}-{% endif %}
                    </td>
                    <td class="px-2 py-2 text-center text-xs bg-blue-50 {% if tech.sla_inspection is not none and tech.sla_inspection >= 0 %}{% if tech.sla_inspection > 7 %}text-red-600 font-medium{% else %}text-green-600 font-medium{% endif %}{% else %}text-gray-400{% endif %}">
                        {% if tech.sla_inspection is not none and tech.sla_inspection >= 0 %}{{ tech.sla_inspection }}{% else %}-{% endif %}
                    </td>
                    <td class="px-2 py-2 text-center text-xs bg-blue-50 {% if tech.sla_dflow is not none and tech.sla_dflow >= 0 %}{% if tech.sla_dflow > 7 %}text-red-600 font-medium{% else %}text-green-600 font-medium{% endif %}{% else %}text-gray-400{% endif %}">
                        {% if tech.sla_dflow is not none and tech.sla_dflow >= 0 %}{{ tech.sla_dflow }}{% else %}-{% endif %}
                    </td>
                    <td class="px-2 py-2 text-center text-xs bg-blue-50 {% if tech.sla_registration is not none and tech.sla_registration >= 0 %}{% if tech.sla_registration > 7 %}text-red-600 font-medium{% else %}text-green-600 font-medium{% endif %}{% else %}text-gray-400{% endif %}">
                        {% if tech.sla_registration is not none and tech.sla_registration >= 0 %}{{ tech.sla_registration }}{% else %}-{% endif %}
                    </td>
                    <td class="px-3 py-2 text-gray-600 text-sm">{{ tech.training_round or '-' }}</td>
                </tr>
                {% endfor %}
                
                {% if pending|length == 0 %}
                <tr>
                    <td colspan="14" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <p>ไม่มีช่างที่รอดำเนินการ</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Legend -->
<div class="mt-4 text-sm text-gray-500">
    <div class="flex flex-wrap gap-4">
        <span class="flex items-center">
            <span class="w-4 h-4 bg-red-50 border border-red-200 rounded mr-1"></span>
            SLA > 60 วัน (เร่งด่วน)
        </span>
        <span class="flex items-center">
            <span class="w-4 h-4 bg-yellow-50 border border-yellow-200 rounded mr-1"></span>
            SLA > 45 วัน (ควรติดตาม)
        </span>
        <span class="flex items-center">
            <span class="w-4 h-4 bg-white border border-gray-200 rounded mr-1"></span>
            SLA ≤ 45 วัน (ปกติ)
        </span>
    </div>
</div>

{% endblock %}
